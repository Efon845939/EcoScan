rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profile documents.
     * @path /databases/{database}/documents/users/{userId}
     * @allow (create) User with UID 's8gA4HUdEBSdep9H4YAQ4zaiTJi2' can create their own profile with matching ID.
     * @allow (get) User with UID 's8gA4HUdEBSdep9H4YAQ4zaiTJi2' can read their own profile.
     * @allow (update) User with UID 's8gA4HUdEBSdep9H4YAQ4zaiTJi2' can update their own profile.
     * @allow (delete) User with UID 's8gA4HUdEBSdep9H4YAQ4zaiTJi2' can delete their own profile.
     * @deny (create) User with UID 'otherUserId' cannot create a profile for 's8gA4HUdEBSdep9H4YAQ4zaiTJi2'.
     * @deny (get) User with UID 'otherUserId' cannot read the profile of 's8gA4HUdEBSdep9H4YAQ4zaiTJi2'.
     * @deny (update) User with UID 'otherUserId' cannot update the profile of 's8gA4HUdEBSdep9H4YAQ4zaiTJi2'.
     * @deny (delete) User with UID 'otherUserId' cannot delete the profile of 's8gA4HUdEBSdep9H4YAQ4zaiTJi2'.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
          return isOwner(userId) && exists(resource);
      }

      allow get: if isOwner(userId);
      allow list: if false; // Do not allow listing of all users.
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to user transaction documents.
     * @path /databases/{database}/documents/users/{userId}/transactions/{transactionId}
     * @allow (create) User with UID 's8gA4HUdEBSdep9H4YAQ4zaiTJi2' can create a transaction under their profile.
     * @allow (get) User with UID 's8gA4HUdEBSdep9H4YAQ4zaiTJi2' can read a transaction under their profile.
     * @allow (update) User with UID 's8gA4HUdEBSdep9H4YAQ4zaiTJi2' can update a transaction under their profile.
     * @allow (delete) User with UID 's8gA4HUdEBSdep9H4YAQ4zaiTJi2' can delete a transaction under their profile.
     * @deny (create) User with UID 'otherUserId' cannot create a transaction for user 's8gA4HUdEBSdep9H4YAQ4zaiTJi2'.
     * @deny (get) User with UID 'otherUserId' cannot read a transaction for user 's8gA4HUdEBSdep9H4YAQ4zaiTJi2'.
     * @deny (update) User with UID 'otherUserId' cannot update a transaction for user 's8gA4HUdEBSdep9H4YAQ4zaiTJi2'.
     * @deny (delete) User with UID 'otherUserId' cannot delete a transaction for user 's8gA4HUdEBSdep9H4YAQ4zaiTJi2'.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/transactions/{transactionId} {
        function isSignedIn() {
          return request.auth != null;
        }

        function isOwner(userId) {
          return request.auth.uid == userId;
        }

        function isExistingOwner(userId) {
            return isOwner(userId) && exists(resource);
        }

        allow get: if isOwner(userId);
        allow list: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update: if isExistingOwner(userId);
        allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Allows public read access to recycling bin information. Write access is currently open.
     * @path /databases/{database}/documents/recycling_bins/{binId}
     * @allow (get) Any user can read recycling bin information.
     * @allow (list) Any user can list recycling bins.
     * @deny (create) No user can create recycling bins without authorization. // TODO: Add role-based authorization
     * @deny (update) No user can update recycling bins without authorization. // TODO: Add role-based authorization
     * @deny (delete) No user can delete recycling bins without authorization. // TODO: Add role-based authorization
     * @principle Allows public read access with restricted write access.
     */
    match /recycling_bins/{binId} {
      allow get: if true;
      allow list: if true;
      allow create: if false; // TODO: Add role-based authorization
      allow update: if false; // TODO: Add role-based authorization
      allow delete: if false; // TODO: Add role-based authorization
    }

    /**
     * @description Allows public read access to partner store information. Write access is currently open.
     * @path /databases/{database}/documents/partner_stores/{storeId}
     * @allow (get) Any user can read partner store information.
     * @allow (list) Any user can list partner stores.
     * @deny (create) No user can create partner stores without authorization. // TODO: Add role-based authorization
     * @deny (update) No user can update partner stores without authorization. // TODO: Add role-based authorization
     * @deny (delete) No user can delete partner stores without authorization. // TODO: Add role-based authorization
     * @principle Allows public read access with restricted write access.
     */
    match /partner_stores/{storeId} {
      allow get: if true;
      allow list: if true;
      allow create: if false; // TODO: Add role-based authorization
      allow update: if false; // TODO: Add role-based authorization
      allow delete: if false; // TODO: Add role-based authorization
    }
  }
}
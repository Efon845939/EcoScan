rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isAnonymousUser() {
      return request.auth.token.firebase.sign_in_provider == 'anonymous';
    }

    // USERS COLLECTION
    match /users/{userId} {
      // Let users read and create their own profile.
      allow get, create: if isOwner(userId);
      allow list, delete: if false; // Deny listing or deleting profiles.

      // Allow updates based on auth type
      allow update: if isOwner(userId) && (
        // Fully authenticated users can update their non-critical fields.
        (
          !isAnonymousUser() &&
          request.resource.data.keys().hasOnly([
            'displayName', 'country', 'phone', 'phoneVerified', 'updatedAt'
          ])
        ) ||
        // Anonymous users can ONLY update their points and survey date.
        (
          isAnonymousUser() &&
          request.resource.data.keys().hasOnly(['totalPoints', 'lastCarbonSurveyDate'])
        ) ||
        // ANY authenticated user (anonymous or full) can update their points and survey date.
        // This is the main fix for the carbon survey issue.
         request.resource.data.keys().hasAll(['totalPoints', 'lastCarbonSurveyDate'])
      );
    }

    // verificationCodes should only be accessed by the backend.
    match /verificationCodes/{codeId} {
      allow read, write: if false;
    }
  }
}
